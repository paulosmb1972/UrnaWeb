<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Direitos Autorais Reservados">
    <title>Sistema de Vota√ß√£o Digital</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #1abc9c; --dark: #0a2a66; --accent: #f1c40f; --danger: #e74c3c; --success: #2ecc71; }
        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--dark); color: white; display: flex; flex-direction: column; align-items: center; -webkit-user-select: none; user-select: none; }
        .screen { display: none; padding: 20px; width: 100%; max-width: 800px; min-height: 90vh; box-sizing: border-box; }
        .active { display: block; }
        h2 { text-align: center; color: var(--primary); margin-bottom: 10px; }
        p.help-text { font-size: 14px; color: #bdc3c7; margin-bottom: 5px; margin-top: 15px; font-style: italic; }
        input, button, textarea { width: 100%; padding: 15px; margin: 5px 0 15px 0; border-radius: 8px; border: none; font-size: 16px; display: block; box-sizing: border-box; }
        button { background: var(--primary); color: white; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        textarea { height: 100px; resize: none; background: #fff; color: #333; }
        
        /* ESTILO DO RELAT√ìRIO PDF */
        #areaImpressao { background: white !important; color: black !important; padding: 40px; border-radius: 10px; width: 100%; box-sizing: border-box; }
        .pdf-header { border-bottom: 3px solid #333; margin-bottom: 30px; padding-bottom: 15px; text-align: center; }
        .pdf-header h1 { margin: 0; color: #000; font-size: 26px; text-transform: uppercase; font-weight: bold; }
        
        .grid-urna { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .card-candidato { background: white; color: #333; padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; border: 4px solid transparent; }
        .card-candidato.selected { border-color: var(--accent); background: #fdf2a7; }
        .foto-cand { width: 100%; height: 140px; object-fit: cover; border-radius: 5px; background: #eee; }
        
        .lang-box { position: fixed; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 100; }
        .lang-box button { width: auto; padding: 6px 12px; background: rgba(0,0,0,0.8); font-size: 11px; margin: 0; border: 1px solid var(--primary); }
        .pay-card { background: white; color: #333; padding: 15px; border-radius: 12px; text-align: center; border-top: 5px solid var(--danger); margin-bottom: 15px; }
        footer { font-size: 10px; opacity: 0.5; padding: 20px; text-align: center; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="lang-box">
    <button onclick="setLang('pt')">Portugu√™s</button>
    <button onclick="setLang('en')">English</button>
    <button onclick="setLang('es')">Espa√±ol</button>
</div>

<div id="login" class="screen active">
    <h2 data-i18n="tLogin">Acesso ao Sistema</h2>
    <p class="help-text" data-i18n="hEmail">E-mail para validar cr√©ditos:</p>
    <input id="userEmail" type="email" data-i18n="pEmail" placeholder="Seu Gmail...">
    <button onclick="checkEmailBalance()" data-i18n="btnVerifyEmail">Entrar</button>
</div>

<div id="paymentScreen" class="screen">
    <h2 style="color: var(--danger);" data-i18n="tLimit">Cr√©ditos Esgotados</h2>
    <div class="pay-card">
        <h3 data-i18n="tPayOption">Elei√ß√£o Individual</h3>
        <button onclick="window.open('https://mpago.la/2maEAFx', '_blank')" style="background: #009ee3;" data-i18n="btnPay">Pagar R$ 30,00</button>
    </div>
    <div class="pay-card" style="border-top-color: var(--success);">
        <h3 data-i18n="tPayOption20">Pacote 20 Elei√ß√µes</h3>
        <button onclick="window.open('https://mpago.la/1VakcdN', '_blank')" style="background: #009ee3;" data-i18n="btnPay20">Pagar R$ 500,00</button>
    </div>
    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; border: 1px dashed var(--accent);">
        <p class="help-text" data-i18n="hCoupon">Possui um cupom?</p>
        <input id="inputCupom" type="text" data-i18n="pCoupon" placeholder="C√≥digo">
        <button onclick="aplicarCupom()" style="background: var(--accent); color: #333;" data-i18n="btnCoupon">Validar</button>
    </div>
    <button onclick="irPara('login')" style="background:none; border:1px solid white;" data-i18n="btnBack">Voltar</button>
</div>

<div id="setupGeral" class="screen">
    <h2 data-i18n="tGeneral">In√≠cio da Elei√ß√£o</h2>
    <p class="help-text" data-i18n="hElectionName">Nome da elei√ß√£o:</p>
    <input id="tituloEleicaoInput" type="text" data-i18n="pElectionName" placeholder="Ex: Condom√≠nio Orion">
    <button onclick="irParaCargo()" style="background:var(--success);" data-i18n="btnNextStep">Configurar Cargos</button>
</div>

<div id="setupCargo" class="screen">
    <h2 data-i18n="tCargo">Configurar Cargo</h2>
    <input id="nomeCargo" type="text" data-i18n="pCargoName" placeholder="Ex: S√≠ndico">
    <p class="help-text" data-i18n="hVotosQtd">Votos por eleitor:</p>
    <input id="qtdVotos" type="number" value="1" min="1">
    <button onclick="proximoPassoCandidatos()" data-i18n="btnAddCand">Adicionar Candidatos</button>
</div>

<div id="setupCandidatos" class="screen">
    <h2 id="tituloCargoAtual">Candidatos</h2>
    <input id="nomeCand" type="text" data-i18n="pCandName" placeholder="Nome completo">
    <input id="fotoCand" type="file" accept="image/*">
    <button onclick="addCandidato()" style="background:var(--accent); color:#333;" data-i18n="btnToList">Adicionar</button>
    <div id="listaTemp"></div>
    <button onclick="finalizarCargo()" style="background:var(--success);" data-i18n="btnSaveCargo">Salvar Cargo</button>
    <button onclick="iniciarUrna()" data-i18n="btnStartVote">INICIAR VOTA√á√ÉO üó≥Ô∏è</button>
</div>

<div id="urnaVisual" class="screen">
    <h2 id="votoCargoTitulo">Urna</h2>
    <div id="gridVotacao" class="grid-urna"></div>
    <button onclick="confirmarVotoVisual()" style="background:var(--success); margin-top:20px; height:80px; font-size: 20px;" data-i18n="btnConfirmVote">CONFIRMAR VOTO</button>
    <button onclick="exibirResultados()" style="background:var(--danger); margin-top:30px; font-size: 12px;" data-i18n="btnEndElection">ENCERRAR ELEI√á√ÉO</button>
</div>

<div id="resultadosScreen" class="screen">
    <h2 data-i18n="tResults">Resultado</h2>
    <div id="areaImpressao">
        <div class="pdf-header">
            <h1 id="pdfTituloEleicao">NOME DA ELEI√á√ÉO</h1>
            <p id="pdfDataHora"></p>
        </div>
        <div id="containerResultados"></div>
    </div>
    <button onclick="gerarPDF()" style="background:var(--success);" data-i18n="btnDownload">Baixar PDF üìÑ</button>
    
    <div style="margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
        <h3 data-i18n="tFeedback">Sugest√µes ou Pedidos</h3>
        <textarea id="textoFeedback" data-i18n="pFeedback" placeholder="Escreva aqui..."></textarea>
        <button onclick="enviarSugestao()" style="background:var(--accent); color:#333;" data-i18n="btnSendFeedback">Enviar Sugest√£o</button>
    </div>

    <button onclick="location.reload()" style="background:var(--primary); margin-top: 40px;" data-i18n="btnFinish">Nova Elei√ß√£o / Sair</button>
</div>

<footer>&copy; 2026 - Sistema de Vota√ß√£o Digital</footer>

<script>
    // CHAVES E CONFIGURA√á√ïES
    emailjs.init("_PKL4Oj92o48KurSF");
    const CONFIG = {
        SERVICE: "service_oqfbzrm",
        TEMPLATE: "template_t3aio8f",
        BACKEND: "https://urnaweb-backend.paulosmb1972.workers.dev/",
        CUPOM: "MAIS3GRATIS"
    };

    const i18n = {
        pt: { tLogin: "Acesso ao Sistema", pEmail: "Seu Gmail...", btnVerifyEmail: "Entrar", tLimit: "Cr√©ditos Esgotados", tPayOption: "Elei√ß√£o Individual", tPayOption20: "Pacote 20 Elei√ß√µes", btnPay: "Pagar R$ 30,00", btnPay20: "Pagar R$ 500,00", hCoupon: "Possui um cupom?", pCoupon: "C√≥digo", btnCoupon: "Validar", btnBack: "Voltar", tGeneral: "In√≠cio da Elei√ß√£o", pElectionName: "Ex: Condom√≠nio Orion", btnNextStep: "Pr√≥ximo", tCargo: "Configurar Cargo", pCargoName: "Ex: S√≠ndico", hVotosQtd: "Votos por eleitor:", btnAddCand: "Candidatos", pCandName: "Nome completo", btnToList: "Adicionar", btnSaveCargo: "Salvar Cargo", btnStartVote: "INICIAR VOTA√á√ÉO üó≥Ô∏è", btnConfirmVote: "CONFIRMAR VOTO", btnEndElection: "ENCERRAR ELEI√á√ÉO", tResults: "Resultado", btnDownload: "Baixar PDF üìÑ", tFeedback: "Sugest√µes ou Pedidos", pFeedback: "Sua sugest√£o...", btnSendFeedback: "Enviar", btnFinish: "Nova Elei√ß√£o / Sair" },
        en: { tLogin: "System Access", pEmail: "Your Gmail...", btnVerifyEmail: "Login", tLimit: "Credits Exhausted", tPayOption: "Single Election", tPayOption20: "20 Elections Pack", btnPay: "Pay R$ 30.00", btnPay20: "Pay R$ 500.00", hCoupon: "Have a coupon?", pCoupon: "Code", btnCoupon: "Validate", btnBack: "Back", tGeneral: "Election Setup", pElectionName: "e.g. Orion Condo", btnNextStep: "Next", tCargo: "Position Setup", pCargoName: "e.g. Trustee", hVotosQtd: "Votes per voter:", btnAddCand: "Add Candidates", pCandName: "Full name", btnToList: "Add", btnSaveCargo: "Save Position", btnStartVote: "START VOTING üó≥Ô∏è", btnConfirmVote: "CONFIRM VOTO", btnEndElection: "END ELECTION", tResults: "Results", btnDownload: "Download PDF üìÑ", tFeedback: "Feedback", pFeedback: "Your suggestion...", btnSendFeedback: "Send", btnFinish: "Exit" },
        es: { tLogin: "Acceso al Sistema", pEmail: "Su Gmail...", btnVerifyEmail: "Entrar", tLimit: "Cr√©ditos Agotados", tPayOption: "Elecci√≥n Individual", tPayOption20: "Paquete 20", btnPay: "Pagar R$ 30.00", btnPay20: "Pagar R$ 500.00", hCoupon: "¬øCup√≥n?", pCoupon: "C√≥digo", btnCoupon: "Validar", btnBack: "Volver", tGeneral: "Configuraci√≥n", pElectionName: "Ej: Condominio Orion", btnNextStep: "Siguiente", tCargo: "Cargo", pCargoName: "Ej: S√≠ndico", hVotosQtd: "Votos por elector:", btnAddCand: "Candidatos", pCandName: "Nombre completo", btnToList: "Agregar", btnSaveCargo: "Guardar Cargo", btnStartVote: "VOTAR üó≥Ô∏è", btnConfirmVote: "CONFIRMAR VOTO", btnEndElection: "FINALIZAR", tResults: "Resultado", btnDownload: "Descargar PDF üìÑ", tFeedback: "Sugerencias", pFeedback: "Su sugerencia...", btnSendFeedback: "Enviar", btnFinish: "Salir" }
    };

    let lang = 'pt';
    let userEmail = "";
    let eleicaoData = [];
    let cargoTemp = null;
    let fotoBase64 = "";
    let votosSelecionados = [];
    let indiceCargoAtual = 0;
    let tituloEleicaoGlobal = "";

    function setLang(l) {
        lang = l;
        document.querySelectorAll("[data-i18n]").forEach(el => {
            const key = el.getAttribute("data-i18n");
            if (i18n[l][key]) {
                if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") el.placeholder = i18n[l][key];
                else el.innerText = i18n[l][key];
            }
        });
    }

    function irPara(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    }

    async function checkEmailBalance() {
        userEmail = document.getElementById("userEmail").value.trim().toLowerCase();
        if(!userEmail.includes("@")) return alert("E-mail inv√°lido");
        
        try {
            const res = await fetch(`${CONFIG.BACKEND}?email=${userEmail}`);
            const data = await res.json();
            if(data.saldo > 0) irPara('setupGeral');
            else irPara('paymentScreen');
        } catch(e) { 
            irPara('setupGeral'); // Fallback para teste
        }
    }

    function aplicarCupom() {
        if(document.getElementById("inputCupom").value.trim().toUpperCase() === CONFIG.CUPOM) {
            alert("Cupom Validado!");
            irPara('setupGeral');
        } else alert("Inv√°lido");
    }

    function irParaCargo() {
        tituloEleicaoGlobal = document.getElementById("tituloEleicaoInput").value;
        if(!tituloEleicaoGlobal) return alert("D√™ um nome!");
        irPara('setupCargo');
    }

    function proximoPassoCandidatos() {
        const nome = document.getElementById("nomeCargo").value;
        if(!nome) return alert("Defina o cargo");
        cargoTemp = { nome, limite: parseInt(document.getElementById("qtdVotos").value), candidatos: [] };
        document.getElementById("tituloCargoAtual").innerText = nome;
        irPara('setupCandidatos');
    }

    document.getElementById('fotoCand').addEventListener('change', (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => fotoBase64 = ev.target.result;
        reader.readAsDataURL(e.target.files[0]);
    });

    function addCandidato() {
        const nome = document.getElementById("nomeCand").value;
        if(!nome) return;
        cargoTemp.candidatos.push({ nome, foto: fotoBase64, votos: 0 });
        document.getElementById("listaTemp").innerHTML += `<div>‚Ä¢ ${nome}</div>`;
        document.getElementById("nomeCand").value = "";
        fotoBase64 = "";
    }

    function finalizarCargo() {
        eleicaoData.push(cargoTemp);
        document.getElementById("nomeCargo").value = "";
        document.getElementById("listaTemp").innerHTML = "";
        irPara('setupCargo');
    }

    function iniciarUrna() {
        if(cargoTemp && !eleicaoData.includes(cargoTemp)) eleicaoData.push(cargoTemp);
        if(eleicaoData.length === 0) return;
        indiceCargoAtual = 0; carregarCargoNaUrna(); irPara('urnaVisual');
    }

    function carregarCargoNaUrna() {
        const cargo = eleicaoData[indiceCargoAtual];
        document.getElementById("votoCargoTitulo").innerText = cargo.nome;
        const grid = document.getElementById("gridVotacao");
        grid.innerHTML = ""; votosSelecionados = [];
        cargo.candidatos.forEach((cand, i) => {
            const card = document.createElement("div");
            card.className = "card-candidato";
            card.innerHTML = `<img src="${cand.foto || ''}" class="foto-cand"><br><strong>${cand.nome}</strong>`;
            card.onclick = () => {
                if(votosSelecionados.includes(i)) {
                    votosSelecionados = votosSelecionados.filter(v => v !== i);
                    card.classList.remove("selected");
                } else if(votosSelecionados.length < cargo.limite) {
                    votosSelecionados.push(i);
                    card.classList.add("selected");
                }
            };
            grid.appendChild(card);
        });
    }

    function confirmarVotoVisual() {
        if(votosSelecionados.length === 0) return alert("Selecione um candidato");
        votosSelecionados.forEach(idx => eleicaoData[indiceCargoAtual].candidatos[idx].votos++);
        indiceCargoAtual++;
        if(indiceCargoAtual < eleicaoData.length) carregarCargoNaUrna();
        else { alert("Voto computado!"); indiceCargoAtual = 0; carregarCargoNaUrna(); }
    }

    function exibirResultados() {
        document.getElementById("pdfTituloEleicao").innerText = tituloEleicaoGlobal;
        document.getElementById("pdfDataHora").innerText = new Date().toLocaleString();
        const container = document.getElementById("containerResultados");
        container.innerHTML = "";
        eleicaoData.forEach(cargo => {
            let html = `<h3 style="border-bottom: 2px solid #1abc9c; padding-bottom: 5px;">${cargo.nome}</h3>`;
            cargo.candidatos.sort((a,b) => b.votos - a.votos).forEach((c, i) => {
                html += `<p>${i+1}¬∫ ${c.nome} ‚Äî ${c.votos} votos</p>`;
            });
            container.innerHTML += html;
        });
        irPara('resultadosScreen');
    }

    function gerarPDF() {
        const element = document.getElementById('areaImpressao');
        html2pdf().from(element).set({ margin: 15, filename: 'resultado.pdf', html2canvas: { scale: 2 } }).save();
    }

    function enviarSugestao() {
        const texto = document.getElementById("textoFeedback").value;
        if(!texto) return;
        emailjs.send(CONFIG.SERVICE, CONFIG.TEMPLATE, { to_email: "paulosmb1972@gmail.com", validation_code: "SUGEST√ÉO: " + texto })
        .then(() => { alert("Enviado!"); document.getElementById("textoFeedback").value = ""; });
    }
</script>
</body>
</html>
