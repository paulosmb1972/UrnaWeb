<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>UrnaWeb</title>

<script>
const userEmail = localStorage.getItem("userEmail");

// chave √∫nica por usu√°rio
const FREE_KEY = "urnaweb_free_used_" + userEmail;

// verifica se j√° usou a vers√£o gr√°tis
function checkFreeAccess(){
    if(localStorage.getItem(FREE_KEY)){
        alert(
          "Sua vota√ß√£o gratuita j√° foi utilizada.\n\n" +
          "Para continuar, √© necess√°rio efetuar o pagamento."
        );
        return false;
    }
    return true;
}

// marca como usado
function markFreeAsUsed(){
    localStorage.setItem(FREE_KEY, "true");
}
</script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
*{box-sizing:border-box}

body{
    margin:0;
    font-family:Arial,Helvetica,sans-serif;
    background:#0a2a66;
    color:white;
    overflow:hidden;
}

.screen{
    display:none;
    padding:20px;
    height:100vh;
}

.active{display:block}

h2,h3,h4{text-align:center;margin:10px 0}

input,button{
    padding:12px;
    font-size:16px;
    width:100%;
    margin:6px 0;
    border-radius:6px;
    border:none;
}

button{
    background:#1abc9c;
    color:black;
    font-weight:bold;
    cursor:pointer;
}

button.secondary{background:#f1c40f}
button.danger{background:#e74c3c;color:white}

.candidate-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:10px;
    height:65vh;
}

.candidate{
    background:#122f5f;
    border:4px solid transparent;
    border-radius:8px;
    padding:8px;
    text-align:center;
    cursor:pointer;
}

.candidate.selected{border-color:#2ecc71}

.candidate img{
    width:100%;
    height:140px;
    object-fit:cover;
    border-radius:6px;
}

.result-box{
    background:white;
    color:black;
    padding:20px;
    font-family:Arial,Helvetica,sans-serif;
}
</style>
</head>

<body>

<!-- CONFIGURA√á√ÉO -->
<div id="setup" class="screen active">
<h2>Configura√ß√£o da Elei√ß√£o</h2>

<input id="electionName" placeholder="Nome da Elei√ß√£o">

<input id="cargoName" placeholder="Nome do Cargo">
<input id="maxVotes" type="number" placeholder="Votos permitidos">

<label>Nomes dos candidatos (.txt)</label>
<input type="file" id="candidateNames" accept=".txt">

<label>Fotos dos candidatos</label>
<input type="file" id="candidatePhotos" accept="image/*" multiple>

<button onclick="addCargo()">Adicionar Cargo</button>
<button class="secondary" onclick="startVoting()">Iniciar Vota√ß√£o</button>

<div id="cargoList"></div>
</div>

<!-- VOTA√á√ÉO -->
<div id="voting" class="screen">
<h2 id="cargoTitle"></h2>
<div id="candidates" class="candidate-grid"></div>
<button onclick="confirmVote()">CONFIRMAR VOTO</button>
</div>

<!-- P√ìS VOTO -->
<div id="afterVote" class="screen">
<h2>VOTO CONFIRMADO</h2>
<p style="text-align:center">Pr√≥ximo eleitor</p>

<button onclick="nextVoter()">Novo Eleitor</button>
<button class="danger" onclick="finishElection()">Encerrar Vota√ß√£o</button>
</div>

<!-- RESULTADO -->
<div id="results" class="screen">
<h2>Resultado Final</h2>
<div id="resultContent"></div>
<button onclick="exportPDF()">Exportar PDF</button>
</div>

<script>
if(!localStorage.getItem("userEmail")){
    window.location.href = "login.html";
}
</script>

let election = { name:"", cargos:[] };
let currentCargo = 0;
let selected = [];

/* ===== ADICIONAR CARGO ===== */
function addCargo(){
    const cargo = document.getElementById("cargoName").value.trim();
    const max = parseInt(document.getElementById("maxVotes").value);
    const namesFile = document.getElementById("candidateNames").files[0];
    const photos = [...document.getElementById("candidatePhotos").files];

    if(!cargo || !max || !namesFile){
        alert("Preencha todos os campos do cargo");
        return;
    }

    const reader = new FileReader();
    reader.onload = () => {
        const names = reader.result.split("\n").filter(n=>n.trim());
        const candidates = names.map((n,i)=>({
            name:n.trim(),
            photo:photos[i] ? URL.createObjectURL(photos[i]) : "",
            votes:0
        }));

        election.cargos.push({cargo,max,candidates});
        document.getElementById("cargoList").innerHTML += `<p>‚úî ${cargo} (${max} voto(s))</p>`;

        document.getElementById("cargoName").value="";
        document.getElementById("maxVotes").value="";
        document.getElementById("candidateNames").value="";
        document.getElementById("candidatePhotos").value="";
    };
    reader.readAsText(namesFile,"UTF-8");
}

/* ===== INICIAR ===== */
function startVoting(){

    // üîí verifica se ainda tem direito √† vota√ß√£o gr√°tis
    if(!checkFreeAccess()){
        return;
    }

    election.name = electionName.value;

    if(!election.name || election.cargos.length === 0){
        alert("Configure a elei√ß√£o primeiro");
        return;
    }

    setup.classList.remove("active");
    showCargo();
}
    election.name = document.getElementById("electionName").value.trim();
    if(!election.name || election.cargos.length === 0){
        alert("Configure a elei√ß√£o primeiro");
        return;
    }
    document.getElementById("setup").classList.remove("active");
    showCargo();
}

/* ===== MOSTRAR CARGO ===== */
function showCargo(){
    selected=[];
    document.getElementById("voting").classList.add("active");

    const cargo = election.cargos[currentCargo];
    document.getElementById("cargoTitle").innerText = cargo.cargo;

    const grid = document.getElementById("candidates");
    grid.innerHTML="";

    cargo.candidates.forEach((c,i)=>{
        const div=document.createElement("div");
        div.className="candidate";
        div.innerHTML=`<img src="${c.photo}"><p>${c.name}</p>`;
        div.onclick=()=>toggle(i,div);
        grid.appendChild(div);
    });
}

/* ===== SELE√á√ÉO ===== */
function toggle(i,div){
    const cargo=election.cargos[currentCargo];
    if(selected.includes(i)){
        selected=selected.filter(x=>x!==i);
        div.classList.remove("selected");
    }else{
        if(selected.length>=cargo.max){
            alert("Limite de votos atingido");
            return;
        }
        selected.push(i);
        div.classList.add("selected");
    }
}

/* ===== CONFIRMAR ===== */
function confirmVote(){
    const cargo=election.cargos[currentCargo];
    selected.forEach(i=>cargo.candidates[i].votes++);

    document.getElementById("voting").classList.remove("active");

    if(currentCargo < election.cargos.length-1){
        currentCargo++;
        showCargo();
    }else{
        document.getElementById("afterVote").classList.add("active");
    }
}

/* ===== NOVO ELEITOR ===== */
function nextVoter(){
    document.getElementById("afterVote").classList.remove("active");
    currentCargo=0;
    showCargo();
}

/* ===== ENCERRAR ===== */
function finishElection()    // marca que a vota√ß√£o gr√°tis foi usada
    markFreeAsUsed();
{
    document.getElementById("afterVote").classList.remove("active");
    document.getElementById("results").classList.add("active");

    const r=document.getElementById("resultContent");
    r.innerHTML=`<h3>${election.name}</h3>`;

    election.cargos.forEach(c=>{
        r.innerHTML+=`<h4>${c.cargo}</h4>`;
        c.candidates.forEach(cd=>{
            r.innerHTML+=`<p>${cd.name}: ${cd.votes} voto(s)</p>`;
        });
    });
}

/* ===== PDF (FUNCIONA) ===== */
function exportPDF(){
    const box=document.createElement("div");
    box.className="result-box";
    box.innerHTML=document.getElementById("resultContent").innerHTML;
    document.body.appendChild(box);

    html2pdf().set({
        margin:10,
        filename:"resultado_eleicao.pdf",
        html2canvas:{scale:2},
        jsPDF:{format:"a4"}
    }).from(box).save().then(()=>box.remove());
}
</script>

</body>
</html>
