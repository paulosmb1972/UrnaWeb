<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>UrnaWeb</title>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
/* ðŸ”´ CONFIGURE AQUI */
const EMAILJS_SERVICE_ID = "SEU_SERVICE_ID";
const EMAILJS_TEMPLATE_ID = "SEU_TEMPLATE_ID";
const EMAILJS_PUBLIC_KEY = "SUA_PUBLIC_KEY";

const PAYMENT_LINK = "https://mpago.la/1VakcdN";

emailjs.init(EMAILJS_PUBLIC_KEY);
</script>

<style>
*{box-sizing:border-box}
body{
    margin:0;
    font-family:Arial,Helvetica,sans-serif;
    background:#0a2a66;
    color:white;
}
.screen{display:none;padding:20px;min-height:100vh}
.active{display:block}
input,button{
    padding:12px;font-size:16px;width:100%;
    margin:6px 0;border-radius:6px;border:none
}
button{background:#1abc9c;font-weight:bold;cursor:pointer}
button.secondary{background:#f1c40f}
button.danger{background:#e74c3c;color:white}
.candidate-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:10px
}
.candidate{
    background:#122f5f;border-radius:8px;
    padding:8px;text-align:center;cursor:pointer
}
.candidate.selected{border:4px solid #2ecc71}
.candidate img{width:100%;height:140px;object-fit:cover;border-radius:6px}
.result-box{background:white;color:black;padding:20px}

.lang-box{position:fixed;top:10px;right:10px}
.lang-box button{width:auto;margin-left:4px}
</style>
</head>

<body>

<div class="lang-box">
<button onclick="setLang('pt')">ðŸ‡§ðŸ‡·</button>
<button onclick="setLang('en')">ðŸ‡ºðŸ‡¸</button>
<button onclick="setLang('es')">ðŸ‡ªðŸ‡¸</button>
</div>

<!-- LOGIN -->
<div id="login" class="screen active">
<h2 id="tLogin"></h2>
<input id="userEmail" placeholder="Digite seu e-mail">
<button onclick="startLogin()">Continuar</button>
</div>

<!-- CÃ“DIGO -->
<div id="codeScreen" class="screen">
<h2>CÃ³digo de ConfirmaÃ§Ã£o</h2>
<p>Enviamos um cÃ³digo para seu e-mail</p>
<input id="codeInput" placeholder="Digite o cÃ³digo">
<button onclick="validateCode()">Validar</button>
</div>

<!-- PAGAMENTO -->
<div id="payment" class="screen">
<h2>Plano Premium</h2>
<p>VocÃª jÃ¡ utilizou a eleiÃ§Ã£o gratuita.</p>
<h3>R$ 15,00 ou US$ 2,99</h3>
<button onclick="window.open(PAYMENT_LINK,'_blank')">Pagar com PIX ou CartÃ£o</button>
<button class="secondary" onclick="unlockPaid()">JÃ¡ paguei</button>
</div>

<!-- CONFIG -->
<div id="setup" class="screen">
<h2 id="tConfig"></h2>
<input id="electionName" placeholder="Nome da EleiÃ§Ã£o">
<input id="cargoName" placeholder="Nome do Cargo">
<input id="maxVotes" type="number" placeholder="Qtd. votos">
<input type="file" id="candidateNames" accept=".txt">
<input type="file" id="candidatePhotos" accept="image/*" multiple>
<button onclick="addCargo()">Adicionar Cargo</button>
<button class="secondary" onclick="startVoting()">Iniciar VotaÃ§Ã£o</button>
<div id="cargoList"></div>
</div>

<!-- VOTAÃ‡ÃƒO -->
<div id="voting" class="screen">
<h2 id="cargoTitle"></h2>
<div id="candidates" class="candidate-grid"></div>
<button id="btnConfirm" onclick="confirmVote()"></button>
</div>

<!-- FINAL -->
<div id="afterVote" class="screen">
<h2 id="tConfirmed"></h2>
<button onclick="nextVoter()">Novo Eleitor</button>
<button class="danger" onclick="finishElection()">Encerrar</button>
</div>

<!-- RESULTADOS -->
<div id="results" class="screen">
<h2 id="tResult"></h2>
<div id="resultContent"></div>
<button onclick="exportPDF()">Exportar PDF</button>
</div>

<script>
let election={name:"",cargos:[]};
let currentCargo=0, selected=[];
let userEmail="", verificationCode="";
let lang=localStorage.getItem("lang")||"pt";

/* TELAS */
function showScreen(id){
document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");
}

/* LOGIN + EMAIL */
function startLogin(){
userEmail=document.getElementById("userEmail").value.trim();
if(!userEmail){alert("Informe o e-mail");return;}

if(localStorage.getItem("paid_"+userEmail)){
showScreen("setup");return;
}

if(!localStorage.getItem("free_"+userEmail)){
sendCode();
}else{
showScreen("payment");
}
}

function sendCode(){
verificationCode=Math.floor(100000+Math.random()*900000).toString();
localStorage.setItem("code_"+userEmail,verificationCode);

emailjs.send(
EMAILJS_SERVICE_ID,
EMAILJS_TEMPLATE_ID,
{to_email:userEmail,code:verificationCode}
).then(()=>{
showScreen("codeScreen");
}).catch(()=>alert("Erro ao enviar e-mail"));
}

function validateCode(){
const input=document.getElementById("codeInput").value.trim();
if(input===localStorage.getItem("code_"+userEmail)){
localStorage.setItem("free_"+userEmail,"used");
showScreen("setup");
}else{
alert("CÃ³digo invÃ¡lido");
}
}

/* PAGAMENTO */
function unlockPaid(){
localStorage.setItem("paid_"+userEmail,"true");
showScreen("setup");
}

/* ELEIÃ‡ÃƒO */
function addCargo(){
const cargo=cargoName.value.trim();
const max=parseInt(maxVotes.value);
const file=candidateNames.files[0];
const photos=[...candidatePhotos.files];
if(!cargo||!max||!file){alert("Campos obrigatÃ³rios");return;}

const r=new FileReader();
r.onload=()=>{
const names=r.result.split("\n").filter(n=>n.trim());
const cands=names.map((n,i)=>({name:n,photo:photos[i]?URL.createObjectURL(photos[i]):"",votes:0}));
election.cargos.push({cargo,max,candidates:cands});
cargoList.innerHTML+=`<p>âœ” ${cargo}</p>`;
cargoName.value=maxVotes.value=candidateNames.value=candidatePhotos.value="";
};
r.readAsText(file,"UTF-8");
}

function startVoting(){
election.name=electionName.value.trim();
if(!election.name||!election.cargos.length){alert("Configure a eleiÃ§Ã£o");return;}
currentCargo=0;showCargo();
}

function showCargo(){
selected=[];showScreen("voting");
const c=election.cargos[currentCargo];
cargoTitle.innerText=c.cargo;
candidates.innerHTML="";
c.candidates.forEach((x,i)=>{
const d=document.createElement("div");
d.className="candidate";
d.innerHTML=`<img src="${x.photo}"><p>${x.name}</p>`;
d.onclick=()=>toggle(i,d);
candidates.appendChild(d);
});
}

function toggle(i,d){
const c=election.cargos[currentCargo];
if(selected.includes(i)){selected=selected.filter(x=>x!==i);d.classList.remove("selected");}
else{
if(selected.length>=c.max){alert("Limite atingido");return;}
selected.push(i);d.classList.add("selected");
}
}

function confirmVote(){
const c=election.cargos[currentCargo];
selected.forEach(i=>c.candidates[i].votes++);
currentCargo<candidates.length-1?showCargo():showScreen("afterVote");
}

function nextVoter(){currentCargo=0;showCargo();}

function finishElection(){
showScreen("results");
resultContent.innerHTML=`<h3>${election.name}</h3>`;
election.cargos.forEach(c=>{
resultContent.innerHTML+=`<h4>${c.cargo}</h4>`;
c.candidates.forEach(x=>resultContent.innerHTML+=`<p>${x.name}: ${x.votes}</p>`);
});
}

function exportPDF(){
const b=document.createElement("div");
b.className="result-box";
b.innerHTML=resultContent.innerHTML;
document.body.appendChild(b);
html2pdf().from(b).save().then(()=>b.remove());
}

/* IDIOMAS */
const txt={
pt:{login:"IdentificaÃ§Ã£o do UsuÃ¡rio",config:"ConfiguraÃ§Ã£o da EleiÃ§Ã£o",confirm:"CONFIRMAR VOTO",confirmed:"VOTO CONFIRMADO",result:"Resultado Final"},
en:{login:"User Identification",config:"Election Setup",confirm:"CONFIRM VOTE",confirmed:"VOTE CONFIRMED",result:"Final Results"},
es:{login:"IdentificaciÃ³n del Usuario",config:"ConfiguraciÃ³n de la ElecciÃ³n",confirm:"CONFIRMAR VOTO",confirmed:"VOTO CONFIRMADO",result:"Resultados Finales"}
};
function setLang(l){
lang=l;localStorage.setItem("lang",l);
tLogin.innerText=txt[l].login;
tConfig.innerText=txt[l].config;
btnConfirm.innerText=txt[l].confirm;
tConfirmed.innerText=txt[l].confirmed;
tResult.innerText=txt[l].result;
}
setLang(lang);
</script>

</body>
</html>
