<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Direitos Autorais Reservados">
    <title>Sistema de Vota√ß√£o Digital</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #1abc9c; --dark: #0a2a66; --accent: #f1c40f; --danger: #e74c3c; --success: #2ecc71; }
        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--dark); color: white; display: flex; flex-direction: column; align-items: center; -webkit-user-select: none; user-select: none; }
        .screen { display: none; padding: 20px; width: 100%; max-width: 800px; min-height: 90vh; box-sizing: border-box; }
        .active { display: block; }
        h2 { text-align: center; color: var(--primary); margin-bottom: 10px; }
        p.help-text { font-size: 14px; color: #bdc3c7; margin-bottom: 5px; margin-top: 15px; font-style: italic; }
        input, button, textarea { width: 100%; padding: 15px; margin: 5px 0 15px 0; border-radius: 8px; border: none; font-size: 16px; display: block; box-sizing: border-box; }
        button { background: var(--primary); color: white; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        
        #areaImpressao { background: white !important; color: black !important; padding: 40px; border-radius: 10px; width: 100%; box-sizing: border-box; }
        .pdf-header { border-bottom: 3px solid #333; margin-bottom: 30px; padding-bottom: 10px; text-align: center; }
        .pdf-header h1 { margin: 0; color: #000; font-size: 24px; text-transform: uppercase; }
        
        .grid-urna { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .card-candidato { background: white; color: #333; padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; border: 4px solid transparent; }
        .card-candidato.selected { border-color: var(--accent); background: #fdf2a7; }
        .foto-cand { width: 100%; height: 140px; object-fit: cover; border-radius: 5px; background: #eee; }
        
        .lang-box { position: fixed; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 100; }
        .lang-box button { width: auto; padding: 6px 12px; background: rgba(0,0,0,0.8); font-size: 11px; margin: 0; border: 1px solid var(--primary); }
        .pay-card { background: white; color: #333; padding: 15px; border-radius: 12px; text-align: center; border-top: 5px solid var(--danger); margin-bottom: 15px; }
        footer { font-size: 10px; opacity: 0.5; padding: 20px; text-align: center; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="lang-box">
    <button onclick="setLang('pt')">Portugu√™s</button>
    <button onclick="setLang('en')">English</button>
    <button onclick="setLang('es')">Espa√±ol</button>
</div>

<div id="login" class="screen active">
    <h2 data-i18n="tLogin">Acesso ao Sistema</h2>
    <p class="help-text" data-i18n="hEmail">Insira seu e-mail para validar cr√©ditos:</p>
    <input id="userEmail" type="email" data-i18n="pEmail" placeholder="Seu Gmail...">
    <button onclick="checkEmailBalance()" data-i18n="btnVerifyEmail">Verificar e Entrar</button>
    <p style="text-align: center; font-size: 12px; opacity: 0.7;" data-i18n="pInfo">3 elei√ß√µes iniciais gratuitas.</p>
</div>

<div id="paymentScreen" class="screen">
    <h2 style="color: var(--danger);" data-i18n="tLimit">Cr√©ditos Esgotados</h2>
    
    <div class="pay-card">
        <h3 data-i18n="tPayOption">Elei√ß√£o Individual</h3>
        <button onclick="window.open('https://mpago.la/2maEAFx', '_blank')" style="background: #009ee3;" data-i18n="btnPay">Pagar R$ 30,00</button>
    </div>

    <div class="pay-card" style="border-top-color: var(--success);">
        <h3 data-i18n="tPayOption20">Pacote 20 Elei√ß√µes</h3>
        <button onclick="window.open('https://mpago.la/1VakcdN', '_blank')" style="background: #009ee3;" data-i18n="btnPay20">Pagar R$ 500,00</button>
    </div>

    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; border: 1px dashed var(--accent);">
        <p class="help-text" data-i18n="hCoupon">Possui um cupom?</p>
        <input id="inputCupom" type="text" data-i18n="pCoupon" placeholder="C√≥digo">
        <button onclick="aplicarCupom()" style="background: var(--accent); color: #333;" data-i18n="btnCoupon">Validar Cupom</button>
    </div>
    <button onclick="irPara('login')" style="background:none; border:1px solid white;" data-i18n="btnBack">Voltar</button>
</div>

<div id="verify" class="screen">
    <h2 data-i18n="tConfirm">Verifique seu E-mail</h2>
    <p class="help-text" data-i18n="hCode">Insira o c√≥digo de 6 d√≠gitos enviado:</p>
    <input id="inCode" type="text" data-i18n="pCode" placeholder="C√≥digo de 6 d√≠gitos">
    <button onclick="validar()" data-i18n="btnConfirm">Confirmar</button>
</div>

<div id="setupGeral" class="screen">
    <h2 data-i18n="tGeneral">In√≠cio da Elei√ß√£o</h2>
    <p class="help-text" data-i18n="hElectionName">D√™ um nome para esta elei√ß√£o (ex: Elei√ß√£o de Condom√≠nio):</p>
    <input id="tituloEleicaoInput" type="text" data-i18n="pElectionName" placeholder="Nome da Elei√ß√£o">
    <button onclick="irParaCargo()" style="background:var(--success);" data-i18n="btnNextStep">Pr√≥ximo: Configurar Cargos</button>
</div>

<div id="setupCargo" class="screen">
    <h2 data-i18n="tCargo">Configurar Cargo</h2>
    <p class="help-text" data-i18n="hCargoName">Nome da fun√ß√£o (ex: S√≠ndico, Diretor):</p>
    <input id="nomeCargo" type="text" data-i18n="pCargoName" placeholder="Nome do Cargo">
    <p class="help-text" data-i18n="hVotosQtd">Quantos candidatos o eleitor pode marcar?</p>
    <input id="qtdVotos" type="number" value="1" min="1">
    <button onclick="proximoPassoCandidatos()" data-i18n="btnAddCand">Adicionar Candidatos</button>
</div>

<div id="setupCandidatos" class="screen">
    <h2 id="tituloCargoAtual">Candidatos</h2>
    <p class="help-text" data-i18n="hCandName">Nome completo do candidato:</p>
    <input id="nomeCand" type="text" data-i18n="pCandName" placeholder="Nome do Candidato">
    <p class="help-text" data-i18n="hCandFoto">Selecione uma foto para o candidato:</p>
    <input id="fotoCand" type="file" accept="image/*">
    <button onclick="addCandidato()" style="background:var(--accent); color:#333;" data-i18n="btnToList">Adicionar Candidato</button>
    <div id="listaTemp" style="margin:10px 0; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;"></div>
    <button onclick="finalizarCargo()" style="background:var(--success);" data-i18n="btnSaveCargo">Salvar Cargo</button>
    <button onclick="iniciarUrna()" data-i18n="btnStartVote">FINALIZAR E INICIAR VOTA√á√ÉO üó≥Ô∏è</button>
</div>

<div id="urnaVisual" class="screen">
    <h2 id="votoCargoTitulo">Urna</h2>
    <div id="gridVotacao" class="grid-urna"></div>
    <button onclick="confirmarVotoVisual()" style="background:var(--success); margin-top:20px; height:80px; font-size: 20px;" data-i18n="btnConfirmVote">CONFIRMAR VOTO</button>
    <button onclick="exibirResultados()" style="background:var(--danger); margin-top:30px; font-size: 12px;" data-i18n="btnEndElection">ENCERRAR ELEI√á√ÉO</button>
</div>

<div id="resultadosScreen" class="screen">
    <h2 data-i18n="tResults">Resultado da Apura√ß√£o</h2>
    <div id="areaImpressao">
        <div class="pdf-header">
            <h1 id="pdfTituloEleicao">NOME DA ELEI√á√ÉO</h1>
            <p id="pdfDataHora"></p>
        </div>
        <div id="containerResultados"></div>
    </div>
    <button onclick="gerarPDF()" style="background:var(--success);" data-i18n="btnDownload">Baixar Relat√≥rio PDF üìÑ</button>
    <button onclick="registrarFimEleicao()" style="background:var(--primary);" data-i18n="btnFinish">Nova Elei√ß√£o / Sair</button>
</div>

<footer>&copy; 2024 - Sistema de Vota√ß√£o Digital</footer>

<script>
    document.onkeydown = function(e) {
        if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 73) || (e.ctrlKey && e.keyCode == 85)) return false;
    };

    emailjs.init("_PKL4Oj92o48KurSF");
    const _MK = "ORION001"; // ADMIN TOTAL
    const _MK2 = "ORION002"; // ADMIN PARA TELA DE PAGAMENTO
    const _CK = "MAIS3GRATIS";

    const i18n = {
        pt: {
            tLogin: "Acesso ao Sistema", hEmail: "Insira seu e-mail para validar cr√©ditos:", pEmail: "Seu Gmail...", btnVerifyEmail: "Verificar e Entrar", pInfo: "3 elei√ß√µes iniciais gratuitas.",
            tLimit: "Cr√©ditos Esgotados", tPayOption: "Elei√ß√£o Individual", tPayOption20: "Pacote 20 Elei√ß√µes", btnPay: "Pagar R$ 30,00", btnPay20: "Pagar R$ 500,00", hCoupon: "Possui um cupom?", pCoupon: "C√≥digo", btnCoupon: "Validar Cupom", btnBack: "Voltar",
            tConfirm: "Verifique seu E-mail", hCode: "Insira o c√≥digo de 6 d√≠gitos enviado:", pCode: "C√≥digo de 6 d√≠gitos", btnConfirm: "Confirmar",
            tGeneral: "In√≠cio da Elei√ß√£o", hElectionName: "D√™ um nome para esta elei√ß√£o (ex: Elei√ß√£o de Condom√≠nio):", pElectionName: "Nome da Elei√ß√£o", btnNextStep: "Pr√≥ximo: Configurar Cargos",
            tCargo: "Configurar Cargo", hCargoName: "Nome da fun√ß√£o (ex: S√≠ndico, Diretor):", pCargoName: "Nome do Cargo", hVotosQtd: "Quantos candidatos o eleitor pode marcar?", btnAddCand: "Adicionar Candidatos",
            hCandName: "Nome completo do candidato:", pCandName: "Nome do Candidato", hCandFoto: "Selecione uma foto para o candidato:", btnToList: "Adicionar Candidato", btnSaveCargo: "Salvar Cargo", btnStartVote: "FINALIZAR E INICIAR VOTA√á√ÉO üó≥Ô∏è",
            btnConfirmVote: "CONFIRMAR VOTO", btnEndElection: "ENCERRAR ELEI√á√ÉO", tResults: "Resultado da Apura√ß√£o", btnDownload: "Baixar Relat√≥rio PDF üìÑ", btnFinish: "Nova Elei√ß√£o / Sair",
            msgSelect: "Selecione um candidato.", msgVoteOk: "Voto computado!", msgTitleErr: "D√™ um nome para a elei√ß√£o.", msgCargoErr: "Digite o nome do cargo."
        },
        en: {
            tLogin: "System Access", hEmail: "Enter your email to validate credits:", pEmail: "Your Gmail...", btnVerifyEmail: "Verify and Enter", pInfo: "3 initial free elections.",
            tLimit: "Credits Exhausted", tPayOption: "Individual Election", tPayOption20: "20 Elections Pack", btnPay: "Pay R$ 30.00", btnPay20: "Pay R$ 500.00", hCoupon: "Have a coupon?", pCoupon: "Code", btnCoupon: "Validate Coupon", btnBack: "Back",
            tConfirm: "Check your Email", hCode: "Enter the 6-digit code sent:", pCode: "6-digit code", btnConfirm: "Confirm",
            tGeneral: "Election Start", hElectionName: "Give a name to this election (e.g. Condo Election):", pElectionName: "Election Name", btnNextStep: "Next: Setup Positions",
            tCargo: "Setup Position", hCargoName: "Role name (e.g. Trustee, Director):", pCargoName: "Position Name", hVotosQtd: "How many candidates can the voter select?", btnAddCand: "Add Candidates",
            hCandName: "Candidate full name:", pCandName: "Candidate Name", hCandFoto: "Select a photo for the candidate:", btnToList: "Add Candidate", btnSaveCargo: "Save Position", btnStartVote: "FINISH AND START VOTING üó≥Ô∏è",
            btnConfirmVote: "CONFIRM VOTE", btnEndElection: "END ELECTION", tResults: "Audit Results", btnDownload: "Download PDF Report üìÑ", btnFinish: "New Election / Exit",
            msgSelect: "Select a candidate.", msgVoteOk: "Vote recorded!", msgTitleErr: "Enter an election name.", msgCargoErr: "Enter the position name."
        },
        es: {
            tLogin: "Acceso al Sistema", hEmail: "Ingrese su correo para validar cr√©ditos:", pEmail: "Su Gmail...", btnVerifyEmail: "Verificar y Entrar", pInfo: "3 elecciones iniciales gratuitas.",
            tLimit: "Cr√©ditos Agotados", tPayOption: "Elecci√≥n Individual", tPayOption20: "Paquete 20 Elecciones", btnPay: "Pagar R$ 30.00", btnPay20: "Pagar R$ 500.00", hCoupon: "¬øTiene un cup√≥n?", pCoupon: "C√≥digo", btnCoupon: "Validar Cup√≥n", btnBack: "Volver",
            tConfirm: "Verifique su Correo", hCode: "Ingrese el c√≥digo de 6 d√≠gitos enviado:", pCode: "C√≥digo de 6 d√≠gitos", btnConfirm: "Confirmar",
            tGeneral: "Inicio de la Elecci√≥n", hElectionName: "Nombre de esta elecci√≥n (ej: Elecci√≥n de Condominio):", pElectionName: "Nombre de la Elecci√≥n", btnNextStep: "Siguiente: Configurar Cargos",
            tCargo: "Configurar Cargo", hCargoName: "Nombre de la funci√≥n (ej: S√≠ndico, Director):", pCargoName: "Nombre del Cargo", hVotosQtd: "¬øCu√°ntos candidatos puede marcar el votante?", btnAddCand: "Agregar Candidatos",
            hCandName: "Nombre completo del candidato:", pCandName: "Nombre del Candidato", hCandFoto: "Seleccione una foto para el candidato:", btnToList: "Agregar Candidato", btnSaveCargo: "Guardar Cargo", btnStartVote: "FINALIZAR E INICIAR VOTACI√ìN üó≥Ô∏è",
            btnConfirmVote: "CONFIRMAR VOTO", btnEndElection: "FINALIZAR ELECCI√ìN", tResults: "Resultado del Escrutinio", btnDownload: "Descargar Informe PDF üìÑ", btnFinish: "Nueva Elecci√≥n / Salir",
            msgSelect: "Seleccione un candidato.", msgVoteOk: "¬°Voto computado!", msgTitleErr: "Ponga un nombre a la elecci√≥n.", msgCargoErr: "Escriba el nombre del cargo."
        }
    };

    let lang = 'pt';
    let userEmail = "";
    let codigoEmail = "";
    let eleicaoData = [];
    let cargoTemp = null;
    let fotoBase64 = "";
    let votosSelecionados = [];
    let indiceCargoAtual = 0;
    let tituloEleicaoGlobal = "";

    function setLang(l) {
        lang = l;
        document.querySelectorAll("[data-i18n]").forEach(el => {
            const key = el.getAttribute("data-i18n");
            if (i18n[l][key]) {
                if (el.tagName === "INPUT") el.placeholder = i18n[l][key];
                else el.innerText = i18n[l][key];
            }
        });
    }

    function irPara(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    }

    function checkEmailBalance() {
        const val = document.getElementById("userEmail").value.trim().toUpperCase();
        
        // ORION001: Pula tudo
        if (val === _MK) {
            userEmail = "admin@total.com";
            irPara('setupGeral');
            return;
        }

        // ORION002: Vai para tela de pagamento
        if (val === _MK2) {
            userEmail = "admin@pago.com";
            let history = JSON.parse(localStorage.getItem('urna_data') || "{}");
            history[userEmail] = 4; // For√ßa limite atingido
            localStorage.setItem('urna_data', JSON.stringify(history));
            irPara('paymentScreen');
            return;
        }

        userEmail = val.toLowerCase();
        if(!userEmail.endsWith("@gmail.com")) return alert("Use um @gmail.com");
        
        let history = JSON.parse(localStorage.getItem('urna_data') || "{}");
        if ((history[userEmail] || 0) >= 3) return irPara('paymentScreen');
        
        codigoEmail = Math.floor(100000 + Math.random() * 900000).toString();
        emailjs.send("service_oqfbzrm", "template_t3aio8f", { to_email: userEmail, validation_code: codigoEmail })
        .then(() => { alert("C√≥digo enviado!"); irPara('verify'); });
    }

    function aplicarCupom() {
        const cupom = document.getElementById("inputCupom").value.trim().toUpperCase();
        let history = JSON.parse(localStorage.getItem('urna_data') || "{}");
        if (cupom === _MK || cupom === _CK) {
            history[userEmail] = 0;
            localStorage.setItem('urna_data', JSON.stringify(history));
            alert("Sistema Liberado!");
            irPara('login');
        } else {
            alert("Cupom inv√°lido.");
        }
    }

    function validar() {
        if(document.getElementById("inCode").value === codigoEmail) irPara('setupGeral');
        else alert("C√≥digo incorreto.");
    }

    function irParaCargo() {
        tituloEleicaoGlobal = document.getElementById("tituloEleicaoInput").value;
        if(!tituloEleicaoGlobal) return alert(i18n[lang].msgTitleErr);
        irPara('setupCargo');
    }

    function proximoPassoCandidatos() {
        const nome = document.getElementById("nomeCargo").value;
        if(!nome) return alert(i18n[lang].msgCargoErr);
        cargoTemp = { nome, limite: parseInt(document.getElementById("qtdVotos").value), candidatos: [] };
        document.getElementById("tituloCargoAtual").innerText = (lang === 'pt' ? "Candidatos: " : lang === 'en' ? "Candidates: " : "Candidatos: ") + nome;
        irPara('setupCandidatos');
    }

    document.getElementById('fotoCand').addEventListener('change', (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => fotoBase64 = ev.target.result;
        reader.readAsDataURL(e.target.files[0]);
    });

    function addCandidato() {
        const nome = document.getElementById("nomeCand").value;
        if(!nome) return;
        cargoTemp.candidatos.push({ nome, foto: fotoBase64, votos: 0 });
        document.getElementById("listaTemp").innerHTML += `<div>‚Ä¢ ${nome}</div>`;
        document.getElementById("nomeCand").value = "";
        fotoBase64 = "";
    }

    function finalizarCargo() {
        eleicaoData.push(cargoTemp);
        document.getElementById("nomeCargo").value = "";
        document.getElementById("listaTemp").innerHTML = "";
        irPara('setupCargo');
    }

    function iniciarUrna() {
        if(cargoTemp && !eleicaoData.includes(cargoTemp)) eleicaoData.push(cargoTemp);
        if(eleicaoData.length === 0) return;
        indiceCargoAtual = 0;
        carregarCargoNaUrna();
        irPara('urnaVisual');
    }

    function carregarCargoNaUrna() {
        const cargo = eleicaoData[indiceCargoAtual];
        document.getElementById("votoCargoTitulo").innerText = cargo.nome;
        const grid = document.getElementById("gridVotacao");
        grid.innerHTML = "";
        votosSelecionados = [];
        cargo.candidatos.forEach((cand, i) => {
            const card = document.createElement("div");
            card.className = "card-candidato";
            card.innerHTML = `<img src="${cand.foto || ''}" class="foto-cand"><br><strong>${cand.nome}</strong>`;
            card.onclick = () => {
                if(votosSelecionados.includes(i)) {
                    votosSelecionados = votosSelecionados.filter(v => v !== i);
                    card.classList.remove("selected");
                } else if(votosSelecionados.length < cargo.limite) {
                    votosSelecionados.push(i);
                    card.classList.add("selected");
                }
            };
            grid.appendChild(card);
        });
    }

    function confirmarVotoVisual() {
        if(votosSelecionados.length === 0) return alert(i18n[lang].msgSelect);
        votosSelecionados.forEach(idx => eleicaoData[indiceCargoAtual].candidatos[idx].votos++);
        indiceCargoAtual++;
        if(indiceCargoAtual < eleicaoData.length) carregarCargoNaUrna();
        else { alert(i18n[lang].msgVoteOk); indiceCargoAtual = 0; carregarCargoNaUrna(); }
    }

    function exibirResultados() {
        const agora = new Date();
        document.getElementById("pdfTituloEleicao").innerText = tituloEleicaoGlobal;
        document.getElementById("pdfDataHora").innerText = agora.toLocaleDateString() + " " + agora.toLocaleTimeString();
        const container = document.getElementById("containerResultados");
        container.innerHTML = "";
        eleicaoData.forEach(cargo => {
            let rank = [...cargo.candidatos].sort((a,b) => b.votos - a.votos);
            let html = `<div><h3>${cargo.nome}</h3>`;
            rank.forEach((c, i) => html += `<p><strong>${i+1}¬∫ ${c.nome}</strong> ‚Äî ${c.votos}</p>`);
            container.innerHTML += html + `</div>`;
        });
        irPara('resultadosScreen');
    }

    function gerarPDF() {
        const element = document.getElementById('areaImpressao');
        const opt = { margin: 15, filename: tituloEleicaoGlobal + '.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        html2pdf().set(opt).from(element).save();
    }

    function registrarFimEleicao() {
        if(userEmail !== "admin@total.com") {
            let history = JSON.parse(localStorage.getItem('urna_data') || "{}");
            history[userEmail] = (history[userEmail] || 0) + 1;
            localStorage.setItem('urna_data', JSON.stringify(history));
        }
        location.reload();
    }
</script>
</body>
</html>
