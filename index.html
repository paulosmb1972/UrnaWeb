<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UrnaWeb Digital - INDEX5 PRO</title>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* === (ESTILO ORIGINAL PRESERVADO) === */
:root { --primary:#1abc9c; --dark:#0a2a66; --accent:#f1c40f; --danger:#e74c3c; --success:#2ecc71; }
body{margin:0;font-family:'Segoe UI',Arial;background:var(--dark);color:white;display:flex;flex-direction:column;align-items:center;min-height:100vh}
.screen{display:none;padding:20px;width:100%;max-width:600px}
.active{display:block}
input,button,textarea{width:100%;padding:16px;margin:10px 0;border-radius:10px;border:none;font-size:16px}
button{background:var(--primary);color:#fff;font-weight:bold;cursor:pointer}
#gridUrna div.selected{border-color:var(--success)!important}
</style>
</head>

<body>

<script>
/* ================= CONFIG ================= */
window._cfg = {
    s:'service_oqfbzrm',
    t:'template_t3aio8f',
    k:'yRM6j-xNoNkVxF0CR',
    u:'https://urnaweb-backend.paulosmb1972.workers.dev',
    feedback:'paulosmb1972@gmail.com'
};

emailjs.init(window._cfg.k);

/* ================= ESTADO ================= */
window._code='';
window._idioma='pt';
window._data=[];
window._temp=null;
window._sel=[];
window._idx=0;
window._title='';
window._fotoTemp='';

/* ================= UTIL ================= */
window.GO = (id)=>{
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
};

/* ================= LOGIN ================= */
window.V = async ()=>{
    let e=document.getElementById('uE').value.trim().toLowerCase();
    if(!e.endsWith('@gmail.com')) return alert("Use Gmail");

    try{
        let r=await fetch(window._cfg.u+'/?email='+encodeURIComponent(e));
        let d=await r.json();
        if(d.count>=3){GO('pay');return;}
        window._code=String(d.codigo);
        await emailjs.send(window._cfg.s,window._cfg.t,{to_email:e,validation_code:window._code});
        alert("Código enviado");
        GO('verify');
    }catch{
        alert("Falha no servidor. Usando modo local.");
        window._code="9999";
        GO('verify');
    }
};

window.C=()=>{
    let v=document.getElementById('iC').value.trim();
    if(v===window._code){
        GO('setup');
    }else{
        alert("Código inválido");
    }
};

/* ================= SETUP ================= */
window.N=()=>{
    window._title=document.getElementById('tE').value.trim();
    if(!window._title) return alert("Informe o título");
    GO('setupCargo');
};

/* ================= CARGO ================= */
window.PREV=(i)=>{
    if(!i.files[0])return;
    let r=new FileReader();
    r.onload=e=>{
        window._fotoTemp=e.target.result;
        document.getElementById('imgPrev').src=window._fotoTemp;
        document.getElementById('imgPrev').style.display='block';
    };
    r.readAsDataURL(i.files[0]);
};

window.A=()=>{
    let cargoNome=document.getElementById('nC').value.trim();
    let candNome=document.getElementById('nCand').value.trim();
    if(!cargoNome||!candNome) return;

    if(!window._temp){
        window._temp={n:cargoNome,c:[]};
    }

    window._temp.c.push({n:candNome,v:0,f:window._fotoTemp});
    document.getElementById('nCand').value='';
    window._fotoTemp='';
};

window.SAVE=()=>{
    if(!window._temp||window._temp.c.length===0)
        return alert("Adicione candidatos");

    window._data.push(window._temp);
    window._temp=null;
    document.getElementById('nC').value='';
    alert("Cargo salvo");
};

window.START_VOTE_PROCESS=()=>{
    if(window._temp){
        if(window._temp.c.length===0) return alert("Cargo vazio");
        window._data.push(window._temp);
        window._temp=null;
    }
    if(window._data.length===0) return alert("Nenhum cargo");
    window._idx=0;
    RENDER_URNA();
    GO('urna');
};

/* ================= URNA ================= */
window.RENDER_URNA=()=>{
    let c=window._data[window._idx];
    document.getElementById('uT').innerText=c.n;
    let g=document.getElementById('gridUrna');
    g.innerHTML='';
    window._sel=[];

    c.c.forEach((can,i)=>{
        let d=document.createElement('div');
        d.innerHTML=(can.f?`<img src="${can.f}" style="width:80px"><br>`:'')+can.n;
        d.onclick=()=>{
            window._sel=[i];
            document.querySelectorAll('#gridUrna div').forEach(x=>x.classList.remove('selected'));
            d.classList.add('selected');
        };
        g.appendChild(d);
    });
};

window.VOTE=()=>{
    if(!window._sel.length) return;
    window._data[window._idx].c[window._sel[0]].v++;
    window._idx++;
    if(window._idx<window._data.length){
        RENDER_URNA();
    }else{
        alert("Voto registrado");
        window._idx=0;
        RENDER_URNA();
    }
};

/* ================= RESULTADO ================= */
window.END=()=>{
    document.getElementById('pdf_h1').innerText=window._title;
    GO('res');
};

window.PDF=()=>{
    let el=document.getElementById('areaImpressao');
    html2pdf().from(el).save('Resultado_'+window._title+'.pdf');
};

window.ENVIAR_FEEDBACK=()=>{
    let m=document.getElementById('txtSugestao').value.trim();
    if(!m) return;
    emailjs.send(window._cfg.s,window._cfg.t,{
        to_email:window._cfg.feedback,
        validation_code:'FEEDBACK: '+m
    }).then(()=>alert("Enviado"));
};
</script>

</body>
</html>
