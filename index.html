<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>UrnaWeb</title>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
(function(){
  emailjs.init("yRM6j-xNoNkVxF0CR");
})();
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
*{box-sizing:border-box}
body{
    margin:0;
    font-family:Arial,Helvetica,sans-serif;
    background:#0a2a66;
    color:white;
}
.screen{
    display:none;
    padding:20px;
    min-height:100vh;
}
.active{display:block}
h2,h3,h4{text-align:center}
input,button{
    padding:12px;
    font-size:16px;
    width:100%;
    margin:6px 0;
    border-radius:6px;
    border:none;
}
button{
    background:#1abc9c;
    font-weight:bold;
    cursor:pointer;
}
button.secondary{background:#f1c40f}
button.danger{background:#e74c3c;color:white}
.candidate-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
    gap:10px;
}
.candidate{
    background:#122f5f;
    border:4px solid transparent;
    border-radius:8px;
    padding:8px;
    cursor:pointer;
    text-align:center;
}
.candidate.selected{border-color:#2ecc71}
.candidate img{
    width:100%;
    height:130px;
    object-fit:cover;
    border-radius:6px;
}
.result-box{
    background:white;
    color:black;
    padding:20px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="screen active">
  <h2>Identificação do Usuário</h2>
  <input id="email" placeholder="Digite seu Gmail">
  <button onclick="sendCode()">Continuar</button>
</div>

<!-- VERIFICAÇÃO -->
<div id="verify" class="screen">
  <h2>Código de Verificação</h2>
  <input id="codeInput" placeholder="Digite o código recebido">
  <button onclick="verifyCode()">Confirmar</button>
</div>

<!-- CONFIGURAÇÃO -->
<div id="setup" class="screen">
  <h2>Configuração da Eleição</h2>
  <input id="electionName" placeholder="Nome da eleição">
  <input id="cargoName" placeholder="Nome do cargo">
  <input id="maxVotes" type="number" placeholder="Qtd. de votos">
  <input type="file" id="candidateNames" accept=".txt">
  <input type="file" id="candidatePhotos" accept="image/*" multiple>
  <button onclick="addCargo()">Adicionar Cargo</button>
  <button class="secondary" onclick="startVoting()">Iniciar Votação</button>
  <div id="cargoList"></div>
</div>

<!-- VOTAÇÃO -->
<div id="voting" class="screen">
  <h2 id="cargoTitle"></h2>
  <div id="candidates" class="candidate-grid"></div>
  <button onclick="confirmVote()">CONFIRMAR VOTO</button>
</div>

<!-- FINAL -->
<div id="afterVote" class="screen">
  <h2>VOTO CONFIRMADO</h2>
  <button onclick="nextVoter()">Novo Eleitor</button>
  <button class="danger" onclick="finishElection()">Encerrar</button>
</div>

<!-- RESULTADO -->
<div id="results" class="screen">
  <h2>Resultado Final</h2>
  <div id="resultContent"></div>
  <button onclick="exportPDF()">Exportar PDF</button>
</div>

<script>
let election={name:"",cargos:[]};
let currentCargo=0;
let selected=[];
let verificationCode="";
let freeUsed=localStorage.getItem("freeUsed");

/* TELAS */
function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* EMAIL */
function sendCode(){
  const email=document.getElementById("email").value.trim();
  if(!email.endsWith("@gmail.com")){
    alert("Informe um Gmail válido");
    return;
  }
  verificationCode=Math.floor(100000+Math.random()*900000).toString();

  emailjs.send(
    "service_oqfbzrm",
    "template_t3aio8f",
    { codigo: verificationCode, to_email: email }
  ).then(()=>{
    showScreen("verify");
  },()=>{
    alert("Erro ao enviar o e-mail");
  });
}

function verifyCode(){
  const code=document.getElementById("codeInput").value.trim();
  if(code===verificationCode){
    showScreen("setup");
  }else{
    alert("Código incorreto");
  }
}

/* CARGO */
function addCargo(){
  const cargo=cargoName.value.trim();
  const max=parseInt(maxVotes.value);
  const namesFile=candidateNames.files[0];
  const photos=[...candidatePhotos.files];

  if(!cargo||!max||!namesFile){
    alert("Preencha todos os campos");
    return;
  }

  const reader=new FileReader();
  reader.onload=()=>{
    const names=reader.result.split("\n").filter(n=>n.trim());
    const candidates=names.map((n,i)=>({
      name:n.trim(),
      photo:photos[i]?URL.createObjectURL(photos[i]):"",
      votes:0
    }));
    election.cargos.push({cargo,max,candidates});
    cargoList.innerHTML+=`<p>✔ ${cargo}</p>`;
    cargoName.value=maxVotes.value="";
    candidateNames.value=candidatePhotos.value="";
  };
  reader.readAsText(namesFile,"UTF-8");
}

/* VOTAÇÃO */
function startVoting(){
  if(freeUsed){
    alert("Você já utilizou a eleição gratuita.");
    return;
  }
  election.name=electionName.value.trim();
  if(!election.name||election.cargos.length===0){
    alert("Configure a eleição");
    return;
  }
  localStorage.setItem("freeUsed","true");
  currentCargo=0;
  showCargo();
}

function showCargo(){
  selected=[];
  showScreen("voting");
  const cargo=election.cargos[currentCargo];
  cargoTitle.innerText=cargo.cargo;
  candidates.innerHTML="";
  cargo.candidates.forEach((c,i)=>{
    const div=document.createElement("div");
    div.className="candidate";
    div.innerHTML=`<img src="${c.photo}"><p>${c.name}</p>`;
    div.onclick=()=>toggle(i,div);
    candidates.appendChild(div);
  });
}

function toggle(i,div){
  const cargo=election.cargos[currentCargo];
  if(selected.includes(i)){
    selected=selected.filter(x=>x!==i);
    div.classList.remove("selected");
  }else{
    if(selected.length>=cargo.max){
      alert("Limite atingido");
      return;
    }
    selected.push(i);
    div.classList.add("selected");
  }
}

function confirmVote(){
  const cargo=election.cargos[currentCargo];
  selected.forEach(i=>cargo.candidates[i].votes++);
  if(currentCargo<election.cargos.length-1){
    currentCargo++;
    showCargo();
  }else{
    showScreen("afterVote");
  }
}

function nextVoter(){
  currentCargo=0;
  showCargo();
}

function finishElection(){
  showScreen("results");
  resultContent.innerHTML=`<h3>${election.name}</h3>`;
  election.cargos.forEach(c=>{
    resultContent.innerHTML+=`<h4>${c.cargo}</h4>`;
    c.candidates.forEach(cd=>{
      resultContent.innerHTML+=`<p>${cd.name}: ${cd.votes}</p>`;
    });
  });
}

/* PDF */
function exportPDF(){
  const box=document.createElement("div");
  box.className="result-box";
  box.innerHTML=resultContent.innerHTML;
  document.body.appendChild(box);
  html2pdf().from(box).save().then(()=>box.remove());
}
</script>

</body>
</html>


