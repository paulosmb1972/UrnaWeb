<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>UrnaWeb Pro</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#0a2a66;
  color:white;
}
.screen{display:none;padding:25px;min-height:100vh}
.active{display:block}
.card{
  background:#122f5f;
  border-radius:12px;
  padding:20px;
  max-width:520px;
  margin:auto;
}
input,button{
  width:100%;
  padding:14px;
  margin:8px 0;
  border-radius:8px;
  border:none;
  font-size:16px;
}
button{background:#1abc9c;font-weight:bold;cursor:pointer}
.secondary{background:#f1c40f}
.danger{background:#e74c3c;color:white}
small{opacity:.8}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="screen active">
  <div class="card">
    <h2>UrnaWeb Pro</h2>
    <input id="email" type="email" placeholder="Seu Gmail">
    <button onclick="login()">Entrar</button>
    <small>Login com confirmação por e-mail</small>
  </div>
</div>

<!-- AGUARDANDO CONFIRMAÇÃO -->
<div id="wait" class="screen">
  <div class="card">
    <h3>Confirme seu acesso</h3>
    <p>Enviamos um link para seu e-mail.</p>
    <small>Verifique a caixa de spam</small>
  </div>
</div>

<!-- SETUP -->
<div id="setup" class="screen">
  <div class="card">
    <h3>Nova Eleição</h3>
    <input id="electionName" placeholder="Nome da eleição">
    <button onclick="checkElection()">Iniciar Eleição</button>

    <hr>
    <input id="coupon" placeholder="Cupom promocional">
    <button class="secondary" onclick="applyCoupon()">Aplicar Cupom</button>
  </div>
</div>

<!-- PAGAMENTO -->
<div id="payment" class="screen">
  <div class="card">
    <h3>Plano Profissional</h3>
    <p>Você não possui eleições disponíveis.</p>
    <button onclick="pay()">Pagar R$ 15,00</button>
  </div>
</div>

<!-- ELEIÇÃO -->
<div id="election" class="screen">
  <div class="card">
    <h3 id="elName"></h3>
    <p>Eleição iniciada com sucesso.</p>
    <button onclick="finish()">Encerrar Eleição</button>
  </div>
</div>

<script>
const API = "https://urnaweb-backend.paulosmb1972.workers.dev";
let userEmail = "";

/* UTIL */
function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* LOGIN */
async function login(){
  const email = document.getElementById("email").value.trim().toLowerCase();
  if(!email.endsWith("@gmail.com")){
    alert("Use um Gmail válido");
    return;
  }
  userEmail = email;

  await fetch(API+"/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email})
  });

  show("wait");
}

/* VERIFICAR ELEIÇÃO */
async function checkElection(){
  const r = await fetch(API+"/can-start",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email:userEmail})
  });

  const data = await r.json();

  if(data.allowed){
    startElection();
  }else{
    show("payment");
  }
}

/* CUPOM */
async function applyCoupon(){
  const code = document.getElementById("coupon").value.trim().toUpperCase();
  if(!code) return alert("Digite um cupom");

  const r = await fetch(API+"/coupon",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email:userEmail, code})
  });

  const d = await r.json();
  if(d.success) alert("Cupom aplicado com sucesso!");
  else alert("Cupom inválido");
}

/* PAGAMENTO */
function pay(){
  window.open("https://mpago.la/1VakcdN","_blank");
}

/* ELEIÇÃO */
function startElection(){
  document.getElementById("elName").innerText =
    document.getElementById("electionName").value;
  show("election");
}

function finish(){
  alert("Eleição encerrada");
  show("setup");
}
</script>

</body>
</html>


