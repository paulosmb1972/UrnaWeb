<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>UrnaWeb Pro</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
    margin:0;
    font-family:Segoe UI,Arial;
    background:#0a2a66;
    color:white;
}
.screen{display:none;padding:25px;min-height:100vh}
.active{display:block}
.card{
    background:#122f5f;
    border-radius:12px;
    padding:20px;
    max-width:520px;
    margin:auto;
}
input,button{
    width:100%;
    padding:14px;
    margin:8px 0;
    border-radius:8px;
    border:none;
    font-size:16px;
}
button{background:#1abc9c;font-weight:bold;cursor:pointer}
.secondary{background:#f1c40f}
.danger{background:#e74c3c;color:white}
.candidate-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:12px;
}
.candidate{
    background:#163a75;
    border-radius:10px;
    padding:8px;
    text-align:center;
    cursor:pointer;
    border:4px solid transparent;
}
.candidate.selected{border-color:#2ecc71}
.candidate img{
    width:100%;
    height:130px;
    object-fit:cover;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="screen active">
    <div class="card">
        <h2>UrnaWeb Pro</h2>
        <input id="userEmail" placeholder="Seu e-mail">
        <input id="coupon" placeholder="Cupom promocional (opcional)">
        <button onclick="login()">Continuar</button>
        <p id="couponMsg"></p>
    </div>
</div>

<!-- SETUP -->
<div id="setup" class="screen">
    <div class="card">
        <h3>Configura√ß√£o da Elei√ß√£o</h3>
        <input id="electionName" placeholder="Nome da elei√ß√£o">
        <input id="cargoName" placeholder="Cargo">
        <input id="maxVotes" type="number" placeholder="Votos permitidos">
        <input type="file" id="candidateNames" accept=".txt">
        <input type="file" id="candidatePhotos" accept="image/*" multiple>
        <button onclick="addCargo()">Adicionar Cargo</button>
        <button class="secondary" onclick="startVoting()">Iniciar</button>
        <div id="cargoList"></div>
    </div>
</div>

<!-- VOTA√á√ÉO -->
<div id="voting" class="screen">
    <h2 id="cargoTitle"></h2>
    <div id="candidates" class="candidate-grid"></div>
    <button onclick="confirmVote()">Confirmar Voto</button>
</div>

<!-- FINAL -->
<div id="afterVote" class="screen">
    <div class="card">
        <h3>Voto Confirmado</h3>
        <button onclick="nextVoter()">Novo Eleitor</button>
        <button class="danger" onclick="finishElection()">Encerrar</button>
    </div>
</div>

<!-- RESULTADOS -->
<div id="results" class="screen">
    <div class="card">
        <h3>Resultado Final</h3>
        <div id="resultContent"></div>
        <button onclick="exportPDF()">Exportar PDF</button>
        <button onclick="openDashboard()">Painel de Controle</button>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="screen">
    <div class="card">
        <h3>Painel de Controle</h3>
        <p><b>Elei√ß√µes restantes:</b> <span id="dashElections"></span></p>
        <p><b>Cupom FREE3 usado:</b> <span id="dashFree3"></span></p>
        <p><b>Cupom 50% usado:</b> <span id="dash50"></span></p>
        <button onclick="exportDashboard()">Exportar Relat√≥rio PDF</button>
        <button class="secondary" onclick="show('setup')">Nova Elei√ß√£o</button>
    </div>
</div>

<script>
let election={name:"",cargos:[]};
let currentCargo=0;
let selected=[];

/* NAVEGA√á√ÉO */
function show(id){
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
}

/* LOGIN + CUPONS */
function login(){
    const cup=document.getElementById("coupon").value.trim().toUpperCase();
    let msg=document.getElementById("couponMsg");

    if(cup==="FREE3" && !localStorage.freeUsed){
        localStorage.freeUsed="true";
        localStorage.freeCount="3";
        msg.innerText="üéâ Cupom FREE3 ativado";
    }
    else if(cup==="50OFF" && !localStorage.offUsed){
        localStorage.offUsed="true";
        msg.innerText="üéâ Cupom 50% aplicado";
    }
    else if(cup){
        msg.innerText="‚ùå Cupom inv√°lido ou j√° utilizado";
        return;
    }
    show("setup");
}

/* DASHBOARD */
function openDashboard(){
    dashElections.innerText=localStorage.freeCount||"0";
    dashFree3.innerText=localStorage.freeUsed?"SIM":"N√ÉO";
    dash50.innerText=localStorage.offUsed?"SIM":"N√ÉO";
    show("dashboard");
}

function exportDashboard(){
    const box=document.createElement("div");
    box.style.background="white";
    box.style.color="black";
    box.style.padding="20px";
    box.innerHTML=`
        <h2>Relat√≥rio UrnaWeb Pro</h2>
        <p>Elei√ß√µes restantes: ${localStorage.freeCount||0}</p>
        <p>Cupom FREE3 usado: ${localStorage.freeUsed?"SIM":"N√ÉO"}</p>
        <p>Cupom 50% usado: ${localStorage.offUsed?"SIM":"N√ÉO"}</p>`;
    document.body.appendChild(box);
    html2pdf().from(box).save("relatorio-urnaweb.pdf")
        .then(()=>box.remove());
}

/* ELEI√á√ÉO */
function addCargo(){
    const cargo=cargoName.value;
    const max=+maxVotes.value;
    const namesFile=candidateNames.files[0];
    if(!cargo||!max||!namesFile)return alert("Preencha tudo");

    const r=new FileReader();
    r.onload=()=>{
        const names=r.result.split("\n").filter(n=>n.trim());
        election.cargos.push({
            cargo,max,
            candidates:names.map(n=>({name:n,votes:0,photo:""}))
        });
        cargoList.innerHTML+=`<p>‚úî ${cargo}</p>`;
    };
    r.readAsText(namesFile);
}

function startVoting(){
    if(!election.cargos.length)return alert("Adicione cargos");
    currentCargo=0;
    showCargo();
}

function showCargo(){
    selected=[];
    show("voting");
    const c=election.cargos[currentCargo];
    cargoTitle.innerText=c.cargo;
    candidates.innerHTML="";
    c.candidates.forEach((x,i)=>{
        let d=document.createElement("div");
        d.className="candidate";
        d.innerHTML=`<p>${x.name}</p>`;
        d.onclick=()=>toggle(i,d);
        candidates.appendChild(d);
    });
}

function toggle(i,d){
    const c=election.cargos[currentCargo];
    if(selected.includes(i)){
        selected=selected.filter(x=>x!==i);
        d.classList.remove("selected");
    }else if(selected.length<c.max){
        selected.push(i);
        d.classList.add("selected");
    }
}

function confirmVote(){
    const c=election.cargos[currentCargo];
    selected.forEach(i=>c.candidates[i].votes++);
    currentCargo<election.cargos.length-1?showCargo(++currentCargo):show("afterVote");
}

function nextVoter(){currentCargo=0;showCargo();}

function finishElection(){
    show("results");
    resultContent.innerHTML="";
    election.cargos.forEach(c=>{
        resultContent.innerHTML+=`<h4>${c.cargo}</h4>`;
        c.candidates.forEach(x=>resultContent.innerHTML+=`<p>${x.name}: ${x.votes}</p>`);
    });
    let f=+localStorage.freeCount||0;
    if(f>0)localStorage.freeCount=f-1;
}

function exportPDF(){
    html2pdf().from(resultContent).save();
}
</script>

</body>
</html>
